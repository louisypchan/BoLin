$.add("bn/doh", ["bl/core/kernel"], function(l){var c={_line:"------------------------------------------------------------",debug:function(){},error:function(){},_AssertFailure:function(a,b){if(c.breakOnError)debugger;if(!(this instanceof c._AssertFailure))return new c._AssertFailure(a,b);b&&(a=new String(a||"")+" with hint: \n\t\t"+(new String(b)+"\n"));this.message=new String(a||"");return this}};c._AssertFailure.prototype=Error();c._AssertFailure.prototype.constructor=c._AssertFailure;c._AssertFailure.prototype.name="doh._AssertFailure"; c.Deferred=function(a){this.chain=[];this.id=this._nextId();this.fired=-1;this.paused=0;this.results=[null,null];this.canceller=a;this.silentlyCancelled=!1};l.extend(c.Deferred.prototype,{getTestErrback:function(a,b){var d=this;return function(){try{a.apply(b||c.global||d,arguments)}catch(e){d.reject(e)}}},getTestCallback:function(a,b){var d=this;return function(){try{a.apply(b||c.global||d,arguments)}catch(e){d.reject(e);return}d.resolve(!0)}},_nextId:function(){var a=1;return function(){return a++}}(), cancel:function(){-1==this.fired?(this.canceller?this.canceller(this):this.silentlyCancelled=!0,-1==this.fired&&this.reject(Error("Deferred(unfired)"))):0==this.fired&&this.results[0]&&this.results[0].cancel&&this.results[0].cancel()},_pause:function(){this.paused++},_unpause:function(){this.paused--;0==this.paused&&0<=this.fired&&this._fire()},_continue:function(a){this._resback(a);this._unpause()},_resback:function(a){this.fired=a instanceof Error?1:0;this.results[this.fired]=a;this._fire()},_check:function(){if(-1!= this.fired){if(!this.silentlyCancelled)throw Error("already called!");this.silentlyCancelled=!1}},resolve:function(a){this._check();this._resback(a)},reject:function(a){this._check();a instanceof Error||(a=Error(a));this._resback(a)},then:function(a,b){this.chain.push([a,b]);0<=this.fired&&this._fire();return this},always:function(a){this.then(a,a)},otherwise:function(a){this.then(null,a)},isFulfilled:function(){return 0<=this.fired},isResolved:function(){return 0==this.fired},isRejected:function(){return 1== this.fired},_fire:function(){for(var a=this.chain,b=this.fired,c=this.results[b],e=this,f=null;0<a.length&&0==this.paused;){var g=a.shift()[b];if(null!=g)try{c=g(c),b=c instanceof Error?1:0,c&&c.then&&(f=function(a){e._continue(a)},this._pause())}catch(k){b=1,c=k}}this.fired=b;this.results[b]=c;f&&this.paused&&c.always(f)}});l.extend(c.Deferred.prototype,{getFunctionFromArgs:function(){var a=arguments;if(a[0]&&!a[1]){if("function"==typeof a[0])return a[0];if("string"==typeof a[0])return c.global[a[0]]}else if(a[0]&& a[1])return l.ride(a[0],a[1]);return null},addCallbacks:function(a,b){this.then(a,b)},addCallback:function(a,b){var c=this.getFunctionFromArgs(a,b);2<arguments.length&&(c=l.ride(null,c,arguments,2));return this.then(c)},addErrback:function(a,b){var c=this.getFunctionFromArgs(a,b);2<arguments.length&&(c=l.ride(null,c,arguments,2));return this.otherwise(c)},addBoth:function(a,b){var c=this.getFunctionFromArgs(a,b);2<arguments.length&&(c=l.ride(null,c,arguments,2));return this.always(c)},callback:function(a){this.resolve(a)}, errback:function(a){this.reject(a)}});c._testCount=0;c._groupCount=0;c._errorCount=0;c._failureCount=0;c._currentGroup=null;c._currentTest=null;c._paused=!0;c._init=function(){this._currentTest=this._currentGroup=null;this._failureCount=this._errorCount=0;this.debug(this._testCount,"tests to run in",this._groupCount,"groups")};c._groups={};c._testTypes={};c.registerTestType=function(a,b){c._testTypes[a]=b};c.registerTestType("perf",function(a,b,d){if("perf"===d||"perf"===b.testType)b.testType="perf", c.perfTestResults||(c.perfTestResults={},c.perfTestResults[a]={}),c.perfTestResults[a]||(c.perfTestResults[a]={}),c.perfTestResults[a][b.name]||(c.perfTestResults[a][b.name]={}),b.results=c.perfTestResults[a][b.name],"trialDuration"in b||(b.trialDuration=100),"trialDelay"in b||(b.trialDelay=100),"trialIterations"in b||(b.trialIterations=10)});var p=function(a,b,d){var e=b;if(l.isString(b))e={name:b.replace("/s/g","_"),runTest:new Function("t",b)};else if(l.isFunction(b))if(e={runTest:b},b.name)e.name= b.name;else try{var f=e.runTest+"";0<=f.indexOf("function ")&&(e.name=f.split("function ")[1].split("(",1)[0])}catch(g){}else l.isString(e.runTest)&&(e.runTest=new Function("t",e.runTest));if(!e.runTest)return 0;(b=c._testTypes[d]||c._testTypes[e.testType])&&b(a,e);c._groups[a].push(e);c._testCount++;c._testRegistered(a,e);return e},q=function(a,b){for(var d="\targuments: ",e=0;5>e;e++){var f;f=a[e];f=l.isString(f)?"string("+f+")":typeof f;d+=f}c.debug("ERROR:");b?c.debug("\tillegal arguments provided to doh.register; the test at argument "+ b+" wasn't a test."):c.debug("\tillegal arguments provided to doh.register");c.debug(d)};c._testRegistered=function(a,b){};c._groupStarted=function(a){};c._groupFinished=function(a,b){};c._testStarted=function(a,b){};c._testFinished=function(a,b,c){};c._registerTest=function(a,b,c){var e=this._groups[a];e||(this._groupCount++,e=this._groups[a]=[],e.inFlight=0);if(!b)return e;var f;if(l.isFunction(b)||l.isString(b)||"runTest"in b)return p(a,b,c)?e:0;if(l.isArray(b))for(var g=0;g<b.length;g++){if(f= p(a,b[g],c),!f)return this.debug("ERROR:"),this.debug("\tillegal test is test array; more information follows..."),null}else for(g in b)if(f=b[g],l.isFunction(f)||l.isString(f)?f=p(a,{name:g,runTest:f},c):(f.name=f.name||g,f=p(a,f,c)),!f)return this.debug("ERROR:"),this.debug("\tillegal test is test hash; more information follows..."),null;return e};c._registerTestAndCheck=function(a,b,d,e,f,g,k){var h=0;if(a)if(d){var m=a.match(/([^\!]+)\!(.+)/);m&&(h=m[1],a=m[2])}else m=a&&a.split("!"),3==m.length? (h=m[0],a=m[1],d=m[2]):2==m.length&&(m[1]in c._testTypes?(a=m[0],d=m[1]):(h=m[0],a=m[1]));(m=c._registerTest(a,b,d))?(h&&(m.amdMid=h),g&&(m.setUp=g),k&&(m.tearDown=k)):q(arguments,e)};c._registerUrl=function(a,c,d,e,f){this.debug("ERROR:");this.debug("\tNO registerUrl() METHOD AVAILABLE.")};var r=function(){function a(c,b,e,f){for(var g=c.slice(1),h=d[c[0]],k=0;k<h.length;k++)c=b+(b?"-":"")+h[k],g.length?a(g,c,e,f):e.push(c,f)}var b=["test",function(a,b){c._registerTestAndCheck("ungrouped",b,0,0, a,0,0)},"url",function(a,b){c._registerUrl("ungrouped",b)},"group-test",function(a,b,d){c._registerTestAndCheck(b,d,0,0,a,0,0)},"test-type",function(a,b,d){c._registerTestAndCheck("ungrouped",b,d,1,a,0,0)},"test-up",function(a,b,d){c._registerTestAndCheck("ungrouped",b,0,0,a,d,0)},"group-url",function(a,b,d){c._registerUrl(b,d)},"url-to",function(a,b,d){c._registerUrl("ungrouped",b,d)},"url-type",function(a,b,d){c._registerUrl("ungrouped",b,void 0,d)},"url-args",function(a,b,d){c._registerUrl("ungrouped", b,void 0,0,d)},"group-test-type",function(a,b,d,e){c._registerTestAndCheck(b,d,e,2,a,0,0)},"group-test-up",function(a,b,d,e){c._registerTestAndCheck(b,d,0,2,a,e,0)},"test-type-up",function(a,b,d,e){c._registerTestAndCheck("ungrouped",b,d,0,a,e,0)},"test-up-down",function(a,b,d,e){c._registerTestAndCheck("ungrouped",b,0,0,a,d,e)},"group-url-to",function(a,b,d,e){c._registerUrl(b,d,e)},"group-url-type",function(a,b,d,e){c._registerUrl(b,d,void 0,e)},"group-url-args",function(a,b,d,e){c._registerUrl(b, d,void 0,0,e)},"url-to-type",function(a,b,d,e){c._registerUrl("ungrouped",b,d,e)},"url-to-args",function(a,b,d,e){c._registerUrl("ungrouped",b,d,0,e)},"url-type-args",function(a,b,d,e){c._registerUrl("ungrouped",b,void 0,d,e)},"group-test-type-up",function(a,b,d,e,f){c._registerTestAndCheck(b,d,e,2,a,f,0)},"group-test-up-down",function(a,b,d,e,f){c._registerTestAndCheck(b,d,0,2,a,e,f)},"test-type-up-down",function(a,b,d,e,f){c._registerTestAndCheck("ungrouped",b,2,0,a,e,f)},"group-url-to-type",function(a, b,d,e,f){c._registerUrl(b,d,e,f)},"group-url-to-args",function(a,b,d,e,f){c._registerUrl(b,d,e,0,f)},"group-url-type-args",function(b,a,d,e,f){c._registerUrl(a,d,void 0,e,f)},"url-to-type-args",function(a,b,d,e,f){c._registerUrl("ungrouped",b,d,e,f)},"group-test-type-up-down",function(b,a,d,e,f,g){c._registerTestAndCheck(a,d,e,2,b,f,g)},"group-url-to-type-args",function(b,a,d,e,f,g){c._registerUrl(a,d,e,f,g)}],d={group:"st.sf.s",test:"a.sf.o.f",type:"st",up:"f",down:"f",url:"s",to:"n",args:"o"},e; for(e in d)d[e]=d[e].split(".");e=[];for(var f,g,k,h=0;h<b.length;h++)f=b[h++].split("-"),g=b[h],k=e[f.length-1]||(e[f.length-1]=[]),a(f,"",k,g);return e}();c.register=function(a,b,d,e,f){function g(a){return a instanceof Array?"a":"function"==typeof a?"f":"number"==typeof a?"n":"string"==typeof a?a in c._testTypes?"st":/\(/.test(a)?"sf":"s":"o"}var k=arguments.length,h=r[k-1],m=[],n;for(n=0;n<k;n++)m.push(g(arguments[n]));m=m.join("-");for(n=0;n<h.length;n+=2)if(h[n]==m){h[n+1](arguments,a,b,d,e, f);return}q(arguments)};c.registerDocTests=function(a){for(var b=new dojox.testing.DocTest,c=b.getTests(a),e=c.length,f=[],g=0;g<e;g++){var k=c[g],h="";k.commands.length&&-1!=k.commands[0].indexOf("//")&&(h=k.commands[0].split("//"),h=", "+h[h.length-1]);f.push({runTest:function(a){return function(c){var d=b.runTest(a.commands,a.expectedResult);c.assertTrue(d.success)}}(k),name:"Line "+k.line+h})}this.register("DocTests: "+a,f)};c.registerTest=function(a,b,d){c.register(a+(d?"!"+d:""),b)};c.registerGroup= function(a,b,d,e,f){a=[(a?a:"")+(f?"!"+f:""),b];d&&a.push(d);e&&a.push(e);c.register.apply(c,a)};c.registerTestNs=function(a,b){c.register(a,b)};c.registerTests=function(a,b,d){c.register(a+(d?"!"+d:""),b)};c.registerUrl=function(a,b,d,e,f){c.register(a+(e?"!"+e:""),b+"",d||1E4,f||{})};c.t=c.assertTrue=function(a,b){if(1>arguments.length)throw new c._AssertFailure("assertTrue failed because it was not passed at least 1 argument");if(!eval(a))throw new c._AssertFailure("assertTrue('"+a+"') failed", b);};c.f=c.assertFalse=function(a,b){if(1>arguments.length)throw new c._AssertFailure("assertFalse failed because it was not passed at least 1 argument");if(eval(a))throw new c._AssertFailure("assertFalse('"+a+"') failed",b);};c.e=c.assertError=function(a,b,d,e,f){try{b[d].apply(b,e)}catch(g){if(g instanceof a)return!0;throw new c._AssertFailure("assertError() failed:\n\texpected error\n\t\t"+a+"\n\tbut got\n\t\t"+g+"\n\n",f);}throw new c._AssertFailure("assertError() failed:\n\texpected error\n\t\t"+ a+"\n\tbut no error caught\n\n",f);};c.is=c.assertEqual=function(a,b,d,e){if(void 0===a&&void 0===b)return!0;if(2>arguments.length)throw c._AssertFailure("assertEqual failed because it was not passed 2 arguments");if(a===b||a==b||"number"==typeof a&&"number"==typeof b&&isNaN(a)&&isNaN(b)||l.isArray(a)&&l.isArray(b)&&this._arrayEq(a,b)||"object"==typeof a&&"object"==typeof b&&this._objPropEq(a,b))return!0;if(e)return!1;throw new c._AssertFailure("assertEqual() failed:\n\texpected\n\t\t"+a+"\n\tbut got\n\t\t"+ b+"\n\n",d);};c.isNot=c.assertNotEqual=function(a,b,d){if(void 0===a&&void 0===b)throw new c._AssertFailure("assertNotEqual() failed: not expected |"+a+"| but got |"+b+"|",d);if(2>arguments.length)throw c._AssertFailure("assertEqual failed because it was not passed 2 arguments");if(a===b||a==b)throw new c._AssertFailure("assertNotEqual() failed: not expected |"+a+"| but got |"+b+"|",d);if(l.isArray(a)&&l.isArray(b)&&this._arrayEq(a,b))throw new c._AssertFailure("assertNotEqual() failed: not expected |"+ a+"| but got |"+b+"|",d);if("object"==typeof a&&"object"==typeof b){var e=!1;try{e=this._objPropEq(a,b)}catch(f){if(!(f instanceof c._AssertFailure))throw f;}if(e)throw new c._AssertFailure("assertNotEqual() failed: not expected |"+a+"| but got |"+b+"|",d);}return!0};c._arrayEq=function(a,b){if(a.length!=b.length)return!1;for(var d=0;d<a.length;d++)if(!c.assertEqual(a[d],b[d],0,!0))return!1;return!0};c._objPropEq=function(a,b){if(null===a&&null===b)return!0;if(null===a||null===b)return!1;if(a instanceof Date)return b instanceof Date&&a.getTime()==b.getTime();for(var d in b)if(!(d in a))return!1;for(d in a)if(!(d in b&&c.assertEqual(a[d],b[d],0,!0)))return!1;return!0};c._setupGroupForRun=function(a){var b=this._groups[a];this.debug(this._line);this.debug("GROUP",'"'+a+'"',"has",b.length,"test"+(1<b.length?"s":"")+" to run");c._groupStarted(a)};c._handleFailure=function(a,b,c){this._groups[a].failures++;a="";c instanceof this._AssertFailure?(this._failureCount++,c.fileName&&(a+=c.fileName+":"),c.lineNumber&& (a+=c.lineNumber+" "),a+=c.message,this.error("\t_AssertFailure:",a)):(this._errorCount++,this.error("\tError:",c.message||c));b.runTest.toSource?(b=b.runTest.toSource(),this.debug("\tERROR IN:\n\t\t",b)):this.debug("\tERROR IN:\n\t\t",b.runTest);c.rhinoException?c.rhinoException.printStackTrace():c.javaException&&c.javaException.printStackTrace()};c._runPerfFixture=function(a,b){var d=this._groups[a];b.startTime=new Date;var e=new c.Deferred;d.inFlight++;e.groupName=a;e.fixture=b;var f=!1;e.otherwise(function(d){c._handleFailure(a, b,d);f=!0});var g,k,h=b.timeout;0<h&&(k=setTimeout(function(){e.reject(Error("test timeout in "+b.name.toString()))},h));e.always(function(){k&&clearTimeout(k);g=!0;b.tearDown&&b.tearDown(c);d.inFlight--;!d.inFlight&&d.iterated&&c._groupFinished(a,!d.failures);c._testFinished(a,b,!f);c._paused&&c.run()});var m=b.results;m.trials=[];c._calcTrialIterations(a,b).then(function(d){if(d){var f=b.trialIterations;c.debug("TIMING TEST: ["+b.name+"]\n\t\tITERATIONS PER TRIAL: "+d+"\n\tTRIALS: "+f);var g=function(){var h= new Date,k=new c.Deferred,l={countdown:d},p=function(d){for(;d;)try{if(d.countdown--,d.countdown){var f=b.runTest(c);if(f&&f.then){var g={countdown:d.countdown};f.then(function(){p(g)},function(d){c._handleFailure(a,b,d);b.endTime=new Date;e.reject(d)});d=null}}else k.resolve(new Date),d=null}catch(h){b.endTime=new Date,k.reject(h)}};k.then(function(a){a={trial:b.trialIterations-f,testIterations:d,executionTime:a.getTime()-h.getTime(),average:(a.getTime()-h.getTime())/d};m.trials.push(a);c.debug("\n\t\tTRIAL #: "+ a.trial+"\n\tTIME: "+a.executionTime+"ms.\n\tAVG TEST TIME: "+a.executionTime/a.testIterations+"ms.");f--;f?setTimeout(g,b.trialDelay):(b.endTime=new Date,e.resolve(!0))},function(a){b.endTime=new Date;e.reject(a)});p(l)};g()}},function(a){b.endTime=new Date;e.reject(a)});g||c.pause();return e};c._calcTrialIterations=function(a,b){var d=new c.Deferred;setTimeout(function(){var a=l.ride(b,b.runTest),f=function(g){for(;g;)if(g.curIter<g.iterations)try{var k=a(c);if(k&&k.then){var h={start:g.start,curIter:g.curIter+ 1,iterations:g.iterations};k.then(function(){f(h)},function(a){b.endTime=new Date;d.reject(a)});g=null}else g.curIter++}catch(m){b.endTime=new Date;d.reject(m);break}else if((new Date).getTime()-g.start.getTime()<b.trialDuration){var l={iterations:2*g.iterations,curIter:0};g=null;setTimeout(function(){l.start=new Date;f(l)},50)}else{var p=g.iterations;setTimeout(function(){d.resolve(p)},50);g=null}};f({start:new Date,curIter:0,iterations:5})},10);return d};c._runRegFixture=function(a,b){var d=this._groups[a]; b.startTime=new Date;var e=b.runTest(this);if(e&&e.then){e.promise&&(e=e.promise);d.inFlight++;e.groupName=a;e.fixture=b;var f=!1;e.otherwise(function(d){f||(c._handleFailure(a,b,d),f=!0)});var g,k=function(){if(!g){g=!0;b.endTime=new Date;if(b.tearDown)try{b.tearDown(c)}catch(e){this.debug("Error tearing down test: "+e.message)}d.inFlight--;c._testFinished(a,b,!f);!d.inFlight&&d.iterated&&c._groupFinished(a,!d.failures);c._paused&&c.run()}},h=setTimeout(function(){h&&(c._handleFailure(a,b,Error("test timeout in "+ b.name.toString())),f=!0,k())},b.timeout||1E3);e.always(function(){clearTimeout(h);h=null;k()});g||c.pause();return e}};c._runFixture=function(a,b){var d=this._groups[a];this._testStarted(a,b);var e=!1,f=null;try{if(b.group=d,b.setUp&&b.setUp(this),b.runTest){if("perf"===b.testType)return c._runPerfFixture(a,b);var g=c._runRegFixture(a,b);if(g)return g}}catch(k){e=!0,f=k}b.endTime=new Date;try{b.tearDown&&b.tearDown(this)}catch(h){this.debug("Error tearing down test: "+h.message)}g=new c.Deferred; setTimeout(l.ride(this,function(){e&&this._handleFailure(a,b,f);this._testFinished(a,b,!e);!d.inFlight&&d.iterated?c._groupFinished(a,!d.failures):0<d.inFlight&&(setTimeout(l.ride(this,function(){c.runGroup(a)}),100),this._paused=!0);c._paused&&c.run()}),30);c.pause();return g};c.runGroup=function(a,b){b=b||0;var d=this._groups[a];if(!0!==d.skip&&l.isArray(d)){void 0===d.iterated&&(d.iterated=!1,d.inFlight=0,d.failures=0,this._setupGroupForRun(a),d.setUp&&d.setUp(this));for(var e=b;e<d.length;e++){if(this._paused){this._currentTest= e;return}c._runFixture(a,d[e]);if(this._paused){this._currentTest=e+1;this._currentTest==d.length&&(d.iterated=!0);return}}d.iterated=!0;d.inFlight||(d.tearDown&&d.tearDown(this),c._groupFinished(a,!d.failures))}};c._onEnd=function(){};c._report=function(){this.debug(this._line);this.debug("| TEST SUMMARY:");this.debug(this._line);this.debug("\t",this._testCount,"tests in",this._groupCount,"groups");this.debug("\t",this._errorCount,"errors");this.debug("\t",this._failureCount,"failures")};c.togglePaused= function(){this[this._paused?"run":"pause"]()};c.pause=function(){this._paused=!0};c.run=function(){this._paused=!1;var a=this._currentGroup,b=this._currentTest,c=!1;a||(this._init(),c=!0);this._currentTest=this._currentGroup=null;for(var e in this._groups)if(!c&&e==a||c){if(this._paused)return;this._currentGroup=e;c?this.runGroup(e):(c=!0,this.runGroup(e,b));if(this._paused)return}this._currentTest=this._currentGroup=null;this._paused=!1;this._onEnd();this._report()};c.runOnLoad=function(){$.use(["bl/dom/ready"], function(a){a(function(){c.run()})})};return c});